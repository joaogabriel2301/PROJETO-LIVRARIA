/*PROJETO LIVRARIA*/
/*ALUNOS: Ana Lívia dos Santos Araújo 		20211214010015
		  Gabriela de Sousa Oliveira 		20221214010032
		  João Gabriel de Araújo Oliveira 	20211214010019
*/
CREATE TABLE LIVRARIA.TB_CATEGORIA(
	ID_CATEGORIA INT PRIMARY KEY NOT NULL,
	TIPO VARCHAR(100) NOT NULL
);
CREATE TABLE LIVRARIA.TB_AUTOR(
	ID_AUTOR INT PRIMARY KEY NOT NULL, 
	NOME_AUTOR TEXT NOT NULL,
	QUANT_LIVRO_PUBLI INT NOT NULL
);
CREATE TABLE LIVRARIA.TB_ENDERECO(
	ID_ENDERECO INT PRIMARY KEY NOT NULL,
	RUA TEXT NOT NULL,
	BAIRRO TEXT NOT NULL,
	NUM_RESIDENCIA INT NOT NULL,
	CIDADE TEXT NOT NULL,
	CEP INT NOT NULL,
	PAIS TEXT NOT NULL
);
CREATE TABLE LIVRARIA.TB_CLIENTE(
	ID_CLIENTE INT PRIMARY KEY NOT NULL,
	NOME_CLIENTE TEXT,
	ID_ENDERECO INT REFERENCES LIVRARIA.TB_ENDERECO(ID_ENDERECO) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE TABLE LIVRARIA.TB_LIVRO(
	ID_LIVRO INT PRIMARY KEY NOT NULL,
	ID_CATEGORIA INT REFERENCES LIVRARIA.TB_CATEGORIA(ID_CATEGORIA) ON DELETE CASCADE ON UPDATE CASCADE,
	ID_AUTOR INT REFERENCES LIVRARIA.TB_AUTOR(ID_AUTOR) ON DELETE CASCADE ON UPDATE CASCADE,
	ANO_PUBLICAÇÃO DATE NOT NULL, 
	NOME_LIVRO VARCHAR(100),
	PRECO MONEY
);
CREATE TABLE LIVRARIA.TB_COMPRA(
	ID_COMPRA SERIAL PRIMARY KEY NOT NULL,
	ID_LIVRO INT REFERENCES LIVRARIA.TB_LIVRO(ID_LIVRO) ON DELETE CASCADE ON UPDATE CASCADE,
	ID_CLIENTE INT REFERENCES LIVRARIA.TB_CLIENTE(ID_CLIENTE) ON DELETE CASCADE ON UPDATE CASCADE,
	DATA_PAGAMENTO DATE NOT NULL, 
	FORMA_PAGAMENTO VARCHAR(100) NOT NULL
);
/*INSERÇÃO DE DADOS*/
INSERT INTO LIVRARIA.TB_CATEGORIA
VALUES  (1, 'Literatura e comportamento'),
		(2, 'Técnicos e profissionais'),
		(3, 'Equilíbrio pessoal'),
		(4, 'Periódicos')
INSERT INTO LIVRARIA.TB_AUTOR 
VALUES 	(1, 'John Ronald Reuel Tolkien', 30),
		(2, 'Gilbert Keith Chesterton', 80),
		(3, 'Francisco Faus', 10),
		(4, 'John Bunyan', 20)
INSERT INTO LIVRARIA.TB_CLIENTE
VALUES 	(1, 'Maria de Nazaré', 1),
		(2, 'Tomas Cruise', 2),
		(3, 'Isabel Florentina', 3),
		(4, 'Tiago Almeida', 4)
INSERT INTO LIVRARIA.TB_ENDERECO
VALUES 	(1, 'Rua Primeira', 'Boqueirão', 25, 'Parelhas', 59360000, 'Brasil'),
		(2, 'Rua Segunda', 'Cabo Branco', 20, 'João Pessoa', 58099999, 'Brasil'),
		(3, 'Rua Terceira', 'Castelo Branco', 100, 'Caicó', 59604040, 'Brasil'),
		(4, 'Rua Quarta', 'Centro', 45, 'Parelhas', 59360000, 'Brasil')
INSERT INTO LIVRARIA.TB_LIVRO
VALUES	(1, 1, 1, '1937-09-21', 'O Hobbit', 47.50),
		(2, 1, 2, '1908-05-05', 'Ortodoxia', 24.90),
		(3, 1, 3, '2015-01-03', 'A Paciencia', 42.00),
		(4, 1, 4, '1678-09-15', 'O Peregrino', 24.50)
INSERT INTO LIVRARIA.TB_COMPRA
VALUES	(1, 1, 1, '2024-01-02', 'Cartão de Crédito'),
		(2, 2, 2, '2023-07-03', 'Pix'),
		(3, 3, 3, '2022-03-29', 'Boleto'),
		(4, 4, 4, '2021-01-23', 'Pix')
/*SELECIONAR TABELAS*/
SELECT * FROM LIVRARIA.TB_CATEGORIA
SELECT * FROM LIVRARIA.TB_AUTOR
SELECT * FROM LIVRARIA.TB_ENDERECO
SELECT * FROM LIVRARIA.TB_CLIENTE
SELECT * FROM LIVRARIA.TB_LIVRO
SELECT * FROM LIVRARIA.TB_COMPRA

/*ATUALIZAR DADOS*/
/*A)MUDANÇA DE DADOS DE BAIRROS*/
	UPDATE LIVRARIA.TB_ENDERECO
	SET BAIRRO = 'Ivan Bezerra'
	WHERE ID_ENDERECO = 1
/*B)MUDANÇA DE DADOS PAIS*/
	UPDATE LIVRARIA.TB_ENDERECO
	SET PAIS = 'Inglaterra'
	WHERE ID_ENDERECO = 2

/*DELETAR DADOS*/
/*A)DELETAR CLIENTE*/
	DELETE FROM LIVRARIA.TB_CLIENTE
	WHERE NOME_CLIENTE = 'Isabel Florentina';

/*SUBCONSULTAS*/
/*A)SELECIONAR O NOME DO CLIENTE, ONDE O SEU ID FOI IGUAL A 2 NA TABELA DE COMPRAS*/
	SELECT NOME_CLIENTE
	FROM LIVRARIA.TB_CLIENTE
	WHERE ID_CLIENTE = (
		SELECT ID_CLIENTE
		FROM LIVRARIA.TB_COMPRA WHERE ID_CLIENTE = 2
	)
/*B)SELICIONAR OS NOMES DOS CLIENTES QUE FIZERAM COMPRAS NO MES DE JANEIRO*/
	SELECT NOME_CLIENTE
	FROM LIVRARIA.TB_CLIENTE
	WHERE ID_CLIENTE IN (
		SELECT ID_CLIENTE
		FROM LIVRARIA.TB_COMPRA
		WHERE EXTRACT (MONTH FROM DATA_PAGAMENTO)= 01
	)
/*C)SELICIONAR OS NOMES E IDs DOS CLIENTES QUE FIZERAM MAIS DE UMA COMPRA*/
	SELECT NOME_CLIENTE, ID_CLIENTE
	FROM LIVRARIA.TB_CLIENTE
	WHERE ID_CLIENTE IN(
		SELECT ID_CLIENTE
		FROM LIVRARIA.TB_COMPRA
		GROUP BY ID_CLIENTE
		HAVING COUNT(ID_CLIENTE) > 1);
/*D)SELICIONAR OS NOMES DOS LIVROS QUE TEM VALOR MAIOR DO QUE A MEDIA DE PREÇOS DOS LIVROS*/
	SELECT NOME_LIVRO
	FROM LIVRARIA.TB_LIVRO
	WHERE PRECO>(
		SELECT AVG(CAST(PRECO AS DECIMAL(10,2)))::money AS MEDIA_PRECO
		FROM LIVRARIA.TB_LIVRO
	)